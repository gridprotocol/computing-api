# 开发文档

记录开发情况与待办。

## 最终形态解释

### 用户

在平台提供的前端页面中，用户可以查看提供服务的计算节点列表和节点的详细信息如资源。

在用户用钱包登录后，可以做更多操作，如租用计算节点资源、查看用户当前持有的订单等。

用户在租用过程中，首先会根据自己的资源需求，利用平台提供的筛选将符合条件的计算节点筛选出来，然后可以定义报价，通过平台自动发请求（链下）给计算节点进行协商，协商结果可以通过平台展示给用户，供用户选择。用户选定计算节点后，会发送交易到链上调用市场合约创建订单，并质押订单内报价的代币。随后通知计算节点完成订单的激活并获取计算节点的访问授权，部署自己的服务，部署成功后即可访问并使用该服务。

用户可以选择多个计算节点租用资源，同一个节点只会有一个订单。用户可以重新选择增加资源租用量并协商好新的价格重新生成新订单。

单位价格可能是波动的，在创建订单时填写的价格可以由平台给出推荐值，但最终定价是用户决定的（类似gasfee，有当前的推荐值，比推荐值高更容易被节点接受，推荐值低虽然便宜但容易被节点拒绝）。

另外虽然在订单中用户可以自定义各个资源的数量，但平台可以给出推荐的组合搭配，为非专业的用户提供更友好的选择。甚至可以先根据用户预计部署的服务（需要是公开且常用的）给出推荐的资源配置。

### 计算节点

计算节点除了运行gateway外，也有部分操作需要在平台上完成。

由于注册合约里不会做计算节点信息的遍历，因此需要在链下让计算节点自己也去平台上做一个登记，让其能够在平台上被用户发现。计算节点通过钱包登录后，平台能够获取到节点的地址。后续平台会用这个地址去链上查节点的详细信息比如资源和ip/域名等，并缓存到本地数据库，后续就可以展示给用户看了。如果计算节点在链上还没有注册登记这些信息，节点也可以通过平台填写表单发交易到链上去登记或更新信息，并同步到本地的gateway中。等交易完成上链了，平台才会把信息展示给用户。

为了过滤不良节点，后续平台可能还会加个计算节点的认证门槛，比如做一些基本的计算，以及ip地址的重复检查。

### 质押与增发激励

用户或计算节点都可以选择质押一定数量的代币来获取增发的激励。在平台页面也可以提供该选项，显示用户的质押时间、质押量和质押收益等。

代币增发与创世铸币以及后续订单结算相关，详细参考[合约开发相关](./contract-dev.md)。

## v0.1

目标：设计、实现大致框架。能够运行起一个demo走一趟较为完整的流程。

核心：计算层主要做

- 验证、授权。
- 部署服务、转发请求和响应（k8s部署的计算群）。

暂时不考虑：

- 结算层（区块链），所有相关接口直接返回预设结果跳过该段流程。
- 验证的完整逻辑，只简单检查是否完成了授权申请。
- 复杂的部署、转发逻辑，目前先支持较为固定的部署和转发，保证服务能够初步走通。
- 用户层中的前端、平台部分只需要保证主要流程运行起来，其他功能和信息补全、优化放到后续工作。

预期展示效果：

用户能够在页面上发起请求完成与计算节点的“租约签订”并获得授权（走流程，不考虑内部细节），部署一个指定服务，且后续能够访问服务的根路径页面。这些内容全部都能够以某种形式在前端页面上展示出来。

## v0.2（计算层ok，待用户层接入与扩展实现）

目标：功能和信息补全。

核心：

- 计算层：验证的完整逻辑，以及复杂的转发逻辑。
- 用户层：补全其他辅助使用的功能和信息。

暂时不考虑：

- 结算层（区块链），所有相关接口直接返回预设结果跳过该段流程。但可以开始设计一个初步合约。
- 更灵活的部署方式。

预期展示效果：

更完整且友好的前端页面，能够保证验证流程的完整度，且能够完整地使用部署的服务。

## v0.3（进行中）

转发相关：

- cookie的有效期、保存与验证方式支持。

剩余接口实现：

- 服务中止相关
- 节点重启相关
- 垃圾回收相关

链相关：

- 初版链合约的设计实现，验证和使用。

预期展示效果：

能走完一套预想的完整流程，有基本且正确的功能逻辑（用户与计算节点），保证能够初步开放内测使用。后续版本更迭将针对特定问题解决与优化，不再是大模块实现。

## 优化相关

- 部分模块可加上cache完成一些访问加速。
- 多个部署镜像或部署文件。灵活的部署方式（参数或yaml）。
- 重新部署时涉及的相关操作。
- 转发的方式除了cookie验证外，增加临时URL子页面支持。
- gateway自己的前端页面，以及部署时是否额外加签名相关的操作（防止被他人覆盖）。
- 计算节点门槛验证：可以做个简单的，比如起一个标准docker页面，作为平台登记门槛。

## 后续考虑

1. 计算层安全访问的问题：限制http的数据长度、加访问cache避免重复检查。
2. 用户友好：根据用户filter的需求（资源、价格等），为用户筛选出符合要求的计算节点。自动对这些节点依次走 `greet` 的流程，第一个能走通的就完成租用。